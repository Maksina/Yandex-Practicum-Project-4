### <a name="_b7urdng99y53"></a>**Название задачи:** Миграция на Cassandra: модель данных, стратегии репликации и шардирования
### <a name="_hjk0fkfyohdk"></a>**Автор:** Щуренков Максим
### <a name="_uanumrh8zrui"></a>**Дата:** 16.11.2025

### <a name="_3bfxc9a45514"></a>**Применимость Cassandra**

|**Данные**|**Критичность**|**Применимость Cassandra**|**Обоснование**|
| :- | :- | :- | :- |
|Заказы|Высокая|Нет|Требуется транзакционная логика.|
|Товары|Высокая|Нет|Требуется строгая консистентность данных по остаткам|
|Корзины|Средняя|Да|Высокая скорость обработки записи в БД, встроенный TTL, горизонтальное масштабирование без полного перераспределения|
|История заказов|Низкая|Да|Высокая доступность чтения, только добавление данных без последующих изменений, удобное патиционировение|
|Пользовательские сессии|Низкая|Да|Высокая скорость обработки записи в БД, встроенный TTL, возможность реализации геораспределенности|

### <a name="_3bfxc9a45515"></a>**Модели данных**

1. **Корзины (Carts)**

Для обеспечения равномерного распределения, гибкости и масштабирования разделим данные корзин на 2 части: корзины авторизованных пользователей (user_carts) и корзины неавторизованных пользователей (guest_carts).

**Корзины авторизованных пользователей**

```sql
CREATE TABLE user_carts (
    user_id    UUID,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    expires_at TIMESTAMP,
    status     TEXT,
    items      LIST<FROZEN<{
        product_id UUID,
        category   TEXT,
        quantity   INT
    }>>,
    PRIMARY KEY (user_id)
)
```

- *Partition key*: `user_id`
- *TTL*: Нет автоматического удаления корзин у авторизованных пользователей для повышения UX.
- *Распределение нагрузки*: У каждого пользователя своя партиция -> нагрузка равномерно распределена. При экстремальной нагрузки можно легко масштабировать не вызывая полного перераспределения.

**Корзины неавторизованных пользователей**

```sql
CREATE TABLE guest_carts (
    session_id TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    expires_at TIMESTAMP,
    status     TEXT,
    items      LIST<FROZEN<{
        product_id UUID,
        category   TEXT,
        quantity   INT
    }>>,
    PRIMARY KEY (session_id)
) WITH default_time_to_live = 604800;
```

- *Partition key*: `session_id`
- *TTL*: Автоматическое удаление гостевых корзин через 7 дней. Важно учитывать TTL для самой сессии, т.к. хранить корзину дольше, чем жива сессии - не имеет смысла.
- *Распределение нагрузки*: У каждой сессии своя партиция -> нагрузка равномерно распределена. При экстремальной нагрузки можно легко масштабировать не вызывая полного перераспределения.


2. **История заказов (order_history)**

```sql
CREATE TABLE order_history (
    user_id      UUID,
    order_date   TIMESTAMP,
    order_id     UUID,
    status       TEXT,
    total_price  DECIMAL,
    geo_zone     TEXT,
    items        LIST<FROZEN<{
        product_id UUID,
        category   TEXT,
        price      DECIMAL
    }>>,
    PRIMARY KEY (user_id, order_date)
) WITH CLUSTERING ORDER BY (order_date DESC);
```

- *Partition key*: `user_id`
- *Clustering key*: `order_date`
- *TTL*: Нет автоматического удаления заказов для аналитики и повышения UX.
- *Распределение нагрузки*: У каждого пользователя своя партиция, заказы внутри партизации отсортированные по дате -> нагрузка равномерно распределена.

3. **Пользовательские сессии**

```sql
CREATE TABLE user_sessions (
    session_id   TEXT,        
    user_id      UUID,        
    created_at   TIMESTAMP,
    last_active  TIMESTAMP,
    ip_address   INET,
    user_agent   TEXT,
    status       TEXT,    
    PRIMARY KEY (session_id)
) WITH default_time_to_live = 604800;
```

- *Partition key*: `session_id`
- *TTL*: Автоматическая очистка сессии через 7 дней.
- *Распределение нагрузки*: У каждой сессии своя партиция -> нагрузка равномерно распределена. При экстремальной нагрузки можно легко масштабировать не вызывая полного перераспределения.

### <a name="_3bfxc9a45515"></a>**Целостность данных**

|**Данные**|**Hinted Handoff**|**Read Repair**|**Anti-Entropy Repair**|**Обоснование**|
| :- | :- | :- | :- | :- |
|Корзины|Да|Да(QUORUM)|Да(По рассписанию)|Требуется высокая доступность, но возможна временна неконсистентность|
|История заказов|Да|Да(QUORUM)|Да(По рассписанию)|Редкое обновление, высокие требования к консистентности и целостности|
|Пользовательские сессии|Да|Да(One)|Нет|Максимальная скорость и доступность, низкие требования к целостности|
