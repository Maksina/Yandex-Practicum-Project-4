### <a name="_b7urdng99y53"></a>**Название задачи:** Выявление и устранение «горячих» шардов
### <a name="_hjk0fkfyohdk"></a>**Автор:** Щуренков Максим
### <a name="_uanumrh8zrui"></a>**Дата:** 11.11.2025

### <a name="_3bfxc9a45514"></a>**Метрики**

|**№**|**Метрика**|**Команды MongoDB для получения данных**|**Стратегия мониторинга**|
|1|Распределение чанков|```db.chunks.aggregate([<br/>{ $match: { ns: "somedb.products" } },<br/>{ $group: { _id: "$shard", chunkCount: { $sum: 1 } } },<br/>{ $sort: { chunkCount: -1 } }<br/>])```|Подсчёт чанков на каждом шарде. Если количество чанков значительно превышает (например x2) пороговое значение(например, среднее значение на остальных шардах), значит, данный шард может стать горячим.|
|2|Размер шарда|```db.products.stats()```|Анализ значений size и count. Сравнение значений с остальными шардами, значительное(на 50+%) отклонение от среднего значения указывает, что шард может стать горячим|
|3|Нагрузка на шард в реальном времени|```db.currentOp({<br/>"secs_running": { "$gt": 1 },<br/>"ns": "somedb.products"<br/>})```|Сравнение значений с остальными шардами, значительное(на 50+%) отклонение от среднего значения указывает, что шард может стать горячим|
|4|Активные соединения по шардам|```db.serverStatus().metrics```|Анализ значений connections.current. Сравнение значений с остальными шардами, значительное(на 50+%) отклонение от среднего значения указывает, что шард может стать горячим|

**Технологии для мониторинга:**  
* Prometeus
* Grafana

**Оповещение:**  
* Алертинг на почту ответственной команды


### <a name="_3bfxc9a45516"></a>**Автоматическое перераспределение данных**

1. **Включение и настройка балансировщика**

*Описание*: Балансировщик MongoDB автоматически перемещает чанки при дисбалансе.

*Включение балансировщика:*
```console
sh.setBalancerState(true)
```

*Проверка, что балансировщик включен:*
```console
sh.getBalancerState()
```

2. **Автоматическое дробление чанков**

*Описание*: Автоматическое дробление чанка при достижении им определенного размера.

*Включение функции auto-spit:*
```console
sh.enableAutoSplit()
```

*Проверка, что auto-spit включен:*
```console
sh.isAutoSplitEnabled()
```

3. **Настройка зон для автоматического распределения чанков**

*Описание*: Автоматическое распределение чанков на выбранную группу шардов.

*Добавление шардов в группу*:
```console
sh.addShardToZone("shard1-1", "high_category")
sh.addShardToZone("shard1-2", "high_category")
```

*Привязка шард-ключа к зоне*:
```console
sh.updateZoneKeyRange(
  "somedb.products",
  { "_id": { $minKey: X } },
  { "_id": { $maxKey: Y } },
  "high_capacity"
)
```

*Примечание*: Данный способ работает только с range-based ключами.